# Layers {#layers}

```{r, echo=FALSE}
layers_basic_df = tibble::tribble(
  ~Function, ~Element, ~Geometry,
  "tm_polygons()", "polygons (borders and fill)", "polygons",
  "tm_symbols()", "symbols", "points, polygons, and lines", 
  "tm_lines()", "lines", "lines", 
  "tm_raster()", "raster", "raster",
  "tm_text()", "text", "points, polygons, and lines"
)
layers_extended_df = tibble::tribble(
  ~Function, ~Element, ~Geometry,
  "tm_borders()", "polygons (borders)", "polygons",
  "tm_fill()", "polygons (fill)", "polygons",
  "tm_bubbles()", "bubbles", "points, polygons, and lines",
  "tm_dots()", "dots", "points, polygons, and lines",
  "tm_markers()", "marker symbols", "points, polygons, and lines",
  "tm_square()", "squares", "points, polygons, and lines",
  "tm_iso()", "lines with text labels", "lines",
  "tm_rgb()/tm_rgba()", "raster (RGB image)", "raster"
)
layers_df = rbind(layers_basic_df, 
                  layers_extended_df)
```

\@ref(tab:layers-table)

```{r layers-table, echo=FALSE, warning=FALSE}
library(magrittr)
library(kableExtra)
options(kableExtra.html.bsTable = TRUE)
knitr::kable(layers_df, 
             caption = "Map layers.",
             caption.short = "Map layers.",
             booktabs = TRUE) %>%
  kableExtra::kable_styling("striped",
                            latex_options = "striped", 
                            full_width = FALSE) %>% 
  kableExtra::column_spec(1, bold = TRUE, monospace = TRUE) %>% 
  kableExtra::pack_rows("Basic functions", 1, 5) %>%
  kableExtra::pack_rows("Derived functions", 6, 13)
```

## Shapes and markers <!--JN: I am not sure where this section should go-->

## Color palettes <!--JN: I am not sure where this section should go-->

<!-- reference this bp - https://earthobservatory.nasa.gov/blogs/elegantfigures/2013/08/06/subtleties-of-color-part-2-of-6/ -->

<!-- color as VISUAL VARIABLE! -->
<!-- "Color, along with position, size, shape, value, orientation, and texture is what Jacques Bertin calls a visual variable:" -->
Colors, along with sizes and shapes, are the most often used to express values of attributes or their properties.
Proper use of colors draws the attention of viewers and has a positive impact on the clarity of the presented information. 
On the other hand, poor decisions about colors can lead to misinterpretation of the map.

<!-- As we discussed in ..., -->
<!-- We can express values of attributes in spatial data using colors, shapes, or sizes. -->
<!-- https://en.wikipedia.org/wiki/Color_scheme -->
Colors in R are created based either on the color name or its hexadecimal form.
R understands 657 built-in color names, such as `"red"`, `"lightblue"` or `"gray90"`, that are available using the `colors()` function.
<!-- demo("colors") -->
<!-- http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf -->
Hexadecimal form, on the other hand, can represent 16,777,216 unique colors.
It consists of six-digits prefixed by the `#` (hash) symbol, where red, green, and blue values are each represented by two characters.
In hexadecimal form, `00` is interpreted as `0.0` which means a lack of a particular color and `FF` means `1.0` and shows that the given color has maximal intensity.
For example, `#000000` represents black color, `#FFFFFF` white color, and `#00FF00` green color.
<!-- hex alpha?? -->

<!-- what is a color palette intro -->
Using a single color we are able to draw points, lines, polygon borders, or their areas.
In that scenario, all of the elements will have the same color. 
However, often we want to represent different values in our data using different colors. 
This is a role for color palettes.
A color palette is a set of colors used to distinguish the values of variables on maps.

Color palettes in R are usually stored as a vector of either color names or hexadecimal representations.
For example, `c("red", "green", "blue")` or `c("#66C2A5", "#FC8D62", "#8DA0CB")`.
It allows every one of us to create our own color palettes. 
However, the decision on how to decide which colors to use is not straightforward, and usually requires thinking about several aspects.

Firstly, what kind of variable we want to show? 
<!-- a next sentence is a simplification, as always -->
Is it a <!--qualitative-->categorical variable where each value represents a <!--orderless-->group or a <!--quantitative-->numerical variable in which values have order?
<!-- http://colorspace.r-forge.r-project.org/articles/palette_visualization.html -->
The variable type impacts how it should be presented on the map.
For categorical variables, each color usually should receive the same perceptual weight, which is done by using colors with the same brightness<!--luminance-->, but different hue<!--type of color-->.
On the other hand, for numerical variables, we should easily understand which colors represent lower and which represent higher values.
This is done by manipulating colorfulness<!--chroma,saturation--> and brightness<!--luminance-->.
For example, low values could be presented by a blue color with low colorfulness and high brightness, and with growing values, colorfulness increases and brightness decreases. 

<!-- color perception-->
Next consideration is related to how people <!--(reader/viewers)--> perceive some colors.
Usually, we want them to be able to preliminary understand which values the colors represent without looking at the legend -- colors should be intuitive.
For example, in the case of categorical variables representing land use, we usually want to use some type of blue color for rivers, green for trees, and white for ice.
This idea also extends to numerical variables, where we should think about the association between colors and cultural values.
The blue color is usually connected to cold temperature, while the red color is hot or can represent danger or something not good.
However, we need to be aware that the connection between colors and cultural values varied between cultures.
<!-- http://uxblog.idvsolutions.com/2013/07/language-and-color.html -->

<!-- color blindness -->
Another thing to consider is to use a color palette that is accessible for people with color vision deficiency (color blindness).
<!-- https://en.wikipedia.org/wiki/Color_blindness -->
There are several types of color blindness, with the red-green color blindness (*deuteranomaly*) being the most common.
It is estimated that about XX of the world population is color blind.
<!-- look for stats/references.. -->

<!-- bw -->


<!-- backgroud -->
<!-- Simultaneous contrast. -->
The relation between the selected color palette and other map elements or the map background should be also taken into a consideration.
Using a bright or dark background color on a map has an impact on how people will perceive different color palettes.

<!-- aesthetic -->
<!-- The last thing to consider is .. -->
<!-- similar to lines types, fonts, etc, positions -->
<!-- hard to grasp, hard to learn, look for good examples and be inspired -->
<!-- also related to what is the main goal - website, journal article? -->
<!-- is it A4 or a postcard size?-->

<!-- therefore, there is a lot of existing color palettes, and many of them are grounded in science -->
Gladly, a lot of work has been put on creating color palettes that are grounded in the research of perception and design.
<!-- https://developer.r-project.org/Blog/public/2019/11/21/a-new-palette-for-r/index.html -->
There are three main types of color palettes (Figure \@ref(fig:palette-types)):

- Categorical (also known as Qualitative) - used for presenting categorical information, for example, categories or groups. 
Every color in this type of palettes should receive the same perceptual weight, and the order of colors is meaningless.
<!-- examples -->
- Sequential - used for presenting continuous variables, in which order matters.
Colors in this palette type changes from low to high (or vice versa), which is usually underlined by luminance differences (light-dark contrasts).
<!-- examples -->
- Diverging - used for presenting continuous variables, but where colors diverge from a central neutral value to two extremes.
Therefore, in sense, they consist of two sequential palettes that meet in the midpoint value.
<!-- examples -->



<!-- idea: add two examples to each (e.g., monochrome and part-spectral to sequential) -->
<!-- idea: add spectral schemes -->
```{r palette-types, fig.cap="Examples of three main types of color palettes: categorical, sequential, and diverging", echo=FALSE, fig.asp=0.5}
# y - a named list of palettes
plot_palette_types = function(y){
  
  my_n = length(y[[1]])
  n_colors = length(y)
  ylim = c(0, n_colors)
  
  oldpar = par(mgp = c(2, 0.25, 0), mar = c(0, 5, 0, 0))
  on.exit(par(oldpar))
  plot(
    1,
    1,
    xlim = c(0, max(my_n)),
    ylim = ylim,
    type = "n",
    axes = FALSE,
    bty = "n",
    xlab = "",
    ylab = ""
  )
  
  for (i in seq_len(n_colors)) {
    rect(
      xleft = 0:(my_n - 1),
      ybottom = i - 1,
      xright = 1:my_n,
      ytop = i - 0.2,
      col = y[[i]],
      border = "light grey"
    )
  }
  text(
    rep(0, n_colors),
    (1:n_colors) - 0.6,
    labels = paste(names(y), " "),
    xpd = TRUE,
    adj = 1
  )
}
# JN: probably this figure should use the default tmap color palettes
p_cat = hcl.colors(7, "Set3")
p_seq = rev(hcl.colors(7, "YlOrBr"))
p_div = hcl.colors(7, "RdYlGn")
# p_vir = 
y = list(Diverging = p_div, Sequential = p_seq, Categorical = p_cat)
plot_palette_types(y)
```
<!-- idea: add bivariate/trivariate schemes (if/when implemented in tmap) -->

<!-- add some notes about more complex approaches (e.g. cividis) -->

<!-- black and white (also in contrast to the three main palettes types)-->
<!-- color blindness -->
<!-- palette properties -->
<!-- anti-rainbow -->
<!-- https://eagereyes.org/basics/rainbow-color-map -->
<!-- limitation of the number of colors -->
<!-- interpolation between colors -->
<!-- relation in the background oclor and other colors -->
<!-- using two or more palettes (e.g. lines and points): -->
<!-- color palettes then should be complementary -->

<!-- three ways to set colors in tmap: -->
<!-- 1. vector of colors (names vs hex) -->
<!-- 2. palette functions (e.g. RColorBrewer, rcartocolor, grDevices::hcl.colors) -->
<!-- 3. build-in names in tmap <!-- tmaptools::palette_explorer() --> -->
<!-- <!-- including viridis --> -->
<!-- also the `n` argument -->
<!-- also the `-` sign -->
<!-- The type of palette from aes.palette is automatically determined, but can be overwritten: use "seq" for sequential, "div" for diverging, and "cat" for categorical. -->
<!-- alpha? -->

<!-- resources: -->
<!-- - colorspace -->
<!-- - Polychrome -->
<!-- - https://bookdown.org/hneth/ds4psy/D-2-apx-colors-essentials.html -->
<!-- - https://developer.r-project.org/Blog/public/2019/11/21/a-new-palette-for-r/index.html -->
<!-- add some references about colors theory, color blindness, etc. -->
<!-- https://earthobservatory.nasa.gov/blogs/elegantfigures/2013/09/10/subtleties-of-color-part-6-of-6/ -->

## The color scale styles <!--JN: I am not sure where this section should go-->

```{r}
# replace this data with some new tmap dataset
library(sf)
library(tmap)
file_path = system.file("shapes/world.gpkg", package = "spData")
world = read_sf(file_path)
world_moll = st_transform(world, crs = "+proj=moll")
```

<!-- one plot with five panels: one color/adjacent polygons/categorical/discrete/continuous? -->
<!-- or maybe start with one color/adjacent polygons -->
<!-- and next present three main types of color palettes -->
<!-- after that categorical/discrete/continuous?? -->

```{r}
tm_one = tm_shape(world_moll) +
  tm_polygons(col = "lightblue")
tm_uni = tm_shape(world_moll) +
  tm_polygons(col = "MAP_COLORS")
```


To see and compare examples of every color scale style from **tmap** visit https://geocompr.github.io/post/2019/tmap-color-scales/.
